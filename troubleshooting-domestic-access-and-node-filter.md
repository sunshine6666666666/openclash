# Cudy TR3000 + OpenClash 排障实录（国内访问受限与节点过滤）

> 适用场景：  
> - 代理能用但国内网络异常（Wi-Fi 显示访问受限）  
> - 故障转移会切到不想要的节点（例如香港）  
> - 页面配置反复保存但看起来不生效  

---

## 1. 本次故障现象（真实复盘）

出现过的现象：
- 国外可以访问，国内偶发或持续异常。
- 将策略改动后，终端提示“访问受限”。
- 想在 OpenClash 里排除香港节点，但订阅更新后香港仍在。
- 故障转移组会落到香港节点，影响部分应用体验。

关键结论：
- 这是“配置链路 + 订阅转换 + 组策略候选集”的组合问题，不是单一按钮问题。
- 先保可用，再做精细过滤，效率最高。

---

## 2. 排障思路（必须按顺序）

1. **先判断是不是网络层断了**（不是就别乱动插件）。
2. **再判断 DNS 是否正常**（本地 DNS 与公共 DNS 结果对齐）。
3. **再看 OpenClash 关键开关**（尤其规则遵循项）。
4. **最后处理节点过滤**（先保证业务可用，再做精细化）。

不要反过来做，否则很容易“改了一堆但问题更复杂”。

---

## 3. 本次有效修复步骤

### 3.1 先止血（国内不可用时）

当出现“国内访问受限”时，先执行：

```bash
/etc/init.d/openclash stop; /etc/init.d/dnsmasq restart; /etc/init.d/firewall restart
```

如果仍异常，再重启网络：

```bash
/etc/init.d/network restart
```

说明：本次日志出现过 `udhcpc: no lease`，这是上游租约问题，必须先恢复网络层。

---

### 3.2 修正 DNS 规则遵循（关键）

确认并设置：

```bash
uci set openclash.config.enable_respect_rules='1'; uci commit openclash; /etc/init.d/openclash restart
```

为什么关键：  
该项为 `0` 时，机场波动可能把国内请求也拖慢或拖死；设为 `1` 后，国内直连更稳。

---

### 3.3 验证“国内不受境外故障影响”

执行：

```bash
curl -sS --max-time 5 https://www.baidu.com >/dev/null && echo "国内:OK" || echo "国内:FAIL"; curl -sS --max-time 5 https://api.ipify.org >/dev/null && echo "国外:OK" || echo "国外:FAIL"
```

本次实测结果出现过：
- 正常时：`国内:OK` + `国外:OK`
- 切到坏节点后：`国内:OK` + `国外:FAIL`

这是正确行为，说明“境外挂了，国内仍可用”。

---

### 3.4 节点策略（先稳定）

当过滤规则还没完全确认生效时，先做稳定方案：
- 在 `Metacubexd` 中，将 `CatNet` 先固定到一个实测可用的日本/新加坡节点；
- 确认稳定后，再切回 `故障转移` 自动切换。

这比一上来就硬改过滤更稳。

---

## 4. 关于“排除香港不生效”的真实原因与处理

### 4.1 本次踩坑点

- 在“配置订阅”里填写了排除项，但生效配置文件中仍保留香港节点。
- 根因是订阅转换链路未按预期应用（页面项已填 ≠ 实际配置已重生效）。

### 4.2 可靠做法（操作建议）

可视化建议：
1. 勾选在线订阅转换；
2. 优先使用“筛选白名单”思路（保留你想要的地区）；
3. 保存后执行“订阅行更新 + 更新配置”。

若页面多次尝试仍不生效，可走“文件级强制清理”（见第 6 节）。

---

## 5. 本次验证命令清单（已证明有效）

### 5.1 路由器连通与管理面

```bash
ping -c 2 192.168.1.1
curl -sS -I --max-time 3 http://192.168.1.1 | sed -n '1p'
```

### 5.2 DNS 基线检查

```bash
nslookup www.baidu.com 127.0.0.1; nslookup www.baidu.com 223.5.5.5
```

### 5.3 OpenClash 关键配置检查

```bash
uci show openclash.config
```

重点看：
- `enable_respect_rules='1'`
- `proxy_mode='rule'`
- `operation_mode='fake-ip'`

### 5.4 出口连通检查

```bash
curl -sS --max-time 5 https://api.ipify.org; echo
```

---

## 6. 文件级强制清理（仅在页面方案失效时）

> 说明：以下属于“兜底方案”，先备份再改。  
> 本次已验证可清除香港与“防失联”条目，并恢复为 `CLEAN_OK`。

```bash
cfg="$(uci get openclash.config.config_path)"; bak="${cfg}.bak.$(date +%s)"; cp "$cfg" "$bak"; sed -r -i "/name: '🇭🇰 香港 [0-9]{2} \| 深港专线'/d;/name: '防失联 https:\/\/catnet\.369\.cyou'/d" "$cfg"; sed -r -i "s/'🇭🇰 香港 [0-9]{2} \| 深港专线', ?//g; s/, ?'🇭🇰 香港 [0-9]{2} \| 深港专线'//g; s/'防失联 https:\/\/catnet\.369\.cyou', ?//g; s/, ?'防失联 https:\/\/catnet\.369\.cyou'//g" "$cfg"; /etc/init.d/openclash restart; echo "BACKUP=$bak"
```

验证：

```bash
grep -E "香港 [0-9][0-9] \| 深港专线|防失联 https://catnet\.369\.cyou" "$(uci get openclash.config.config_path)" || echo CLEAN_OK
```

回滚（把备份路径替换成实际输出）：

```bash
cp "这里填BACKUP路径" "$(uci get openclash.config.config_path)"; /etc/init.d/openclash restart
```

---

## 7. 常见误判（避免重复浪费时间）

- **误判 1：** “页面里填了排除节点，肯定已经生效。”  
  - 实际：必须检查生效配置文件。

- **误判 2：** “国内不通一定是代理规则问题。”  
  - 实际：可能是上游租约丢失（`no lease`），先恢复网络层。

- **误判 3：** “国外站返回 403 就是代理坏了。”  
  - 实际：403 是网站策略，不等于链路超时。可换 `api.ipify.org` 验证。

- **误判 4：** “一次改很多项更快。”  
  - 实际：新手场景一次只改一项最稳、最可追踪。

---

## 8. 一分钟自检（建议收藏）

```bash
echo "==开关=="; uci get openclash.config.enable_respect_rules; echo "==国内=="; curl -sS --max-time 5 https://www.baidu.com >/dev/null && echo OK || echo FAIL; echo "==国外=="; curl -sS --max-time 5 https://api.ipify.org >/dev/null && echo OK || echo FAIL
```

判定：
- 国内 OK + 国外 OK：健康
- 国内 OK + 国外 FAIL：机场/节点问题（符合容灾预期）
- 国内 FAIL + 国外 FAIL：优先查网络层和 DNS 服务

---

## 9. 当前可用结论（本次收口）

- 已恢复“国内可访问”；
- 已恢复“国外可访问”；
- 已验证“坏节点场景下国内不受影响”；
- 已可通过文件级方式去除香港与防失联条目，并验证 `CLEAN_OK`；
- 以后维护优先级：**可用性 > 自动化 > 精细策略**。

---

## 10. 大错误示范（禁止再犯）

> 这是本次测试中已经被证明“无效或有害”的操作集合。  
> 下次排障时，把这一节当作“红线清单”先看一遍。

### 错误示范 A：国内不通时，先疯狂改节点和规则

错误动作：
- 国内网络异常时，连续切多个节点、连改多个策略组。
- 没有先确认上游租约和网络连通状态。

为什么错：
- 本次真实日志出现过 `udhcpc: no lease`，说明先是网络层问题。
- 网络层没恢复前，改策略基本无效，还会制造更多变量。

正确做法：
- 先执行网络层止血（停 OpenClash、重启 dnsmasq、防火墙、必要时重启 network）。
- 网络恢复后再改策略。

### 错误示范 B：页面点了“排除香港”，就认定已经生效

错误动作：
- 仅凭 UI 显示判断生效，不检查实际运行配置文件。
- 多次点“更新”但不做文件验证。

为什么错：
- 本次已反复证明：UI 已填项不等于最终配置已应用。

正确做法：
- 每次更新后都执行：
  - `grep -E "香港 [0-9][0-9] \| 深港专线|防失联 https://catnet\.369\.cyou" "$(uci get openclash.config.config_path)" || echo CLEAN_OK`
- 看到 `CLEAN_OK` 才算完成。

### 错误示范 C：一次改很多项，期待“快点好”

错误动作：
- 同时改代理模式、DNS、规则组、订阅过滤、面板节点。
- 出现异常后无法定位是哪一步引入问题。

为什么错：
- 多变量并发修改会让排障不可追踪，回滚成本极高。

正确做法：
- 严格一项一改、一改一验：
  1) 改一项  
  2) 执行验证命令  
  3) 记录结果  
  4) 再改下一项

### 错误示范 D：把“国外站 403”当成“代理失效”

错误动作：
- 用单一网站返回码（如 403）判断代理坏了。

为什么错：
- 403 可能是网站策略，不等同于链路失败。

正确做法：
- 使用通用连通验证：
  - `curl -sS --max-time 5 https://api.ipify.org >/dev/null && echo 国外OK || echo 国外FAIL`
- 联合国内检测一起判定。

### 错误示范 E：没有备份就直接改配置文件

错误动作：
- 直接 `sed -i` 修改生效配置，不先备份。

为什么错：
- 一旦正则误删，恢复困难且耗时。

正确做法：
- 先备份再改，必须拿到 `BACKUP=...` 路径。
- 修改后先 `grep` 验证，再决定是否继续。

### 错误示范 F：情绪上头时继续操作

错误动作：
- 连续失败后加速操作、跳步操作、同时操作多入口（UI + CLI）。

为什么错：
- 最容易造成“问题叠加”和状态失真。

正确做法：
- 立即暂停 1 分钟，只保留单一入口（先 CLI），按固定顺序执行：
  1) 网络层  
  2) DNS  
  3) OpenClash 关键开关  
  4) 节点策略  
  5) 文件验证

### 错误红线（执行前自检）

只要满足任意一条，就**不允许继续改配置**：
- 没有先跑国内/国外连通性检查；
- 没有确认 `enable_respect_rules='1'`；
- 没有备份文件却准备直接改 YAML；
- 一次准备改超过 1 个配置项。

**记住一句话：先恢复可用，再做优化；先证据验证，再宣布生效。**

